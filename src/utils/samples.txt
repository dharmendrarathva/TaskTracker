import mongoose, { Schema, Document, Model } from "mongoose";

export interface ITask extends Document {
  planId: mongoose.Types.ObjectId;
  title: string;
  estimatedMinutes?: number;
  createdAt: Date;
  updatedAt: Date;
}

const TaskSchema = new Schema<ITask>(
  {
    planId: {
      type: Schema.Types.ObjectId,
      ref: "Plan",
      required: true,
      index: true,
    },
    title: { type: String, required: true, trim: true },
    estimatedMinutes: Number,
  },
  { timestamps: true }
);

TaskSchema.index({ planId: 1 });

export default (mongoose.models.Task as Model<ITask>) ||
  mongoose.model<ITask>("Task", TaskSchema);

  import mongoose, { Schema, Document, Model } from "mongoose";

export interface IProgress extends Document {
  planId: mongoose.Types.ObjectId;
  taskId: mongoose.Types.ObjectId;
  dayNumber: number;
  date: Date;
  completed: boolean;
  actualMinutesSpent?: number;
}

const ProgressSchema = new Schema<IProgress>(
  {
    planId: {
      type: Schema.Types.ObjectId,
      ref: "Plan",
      required: true,
      index: true,
    },
    taskId: {
      type: Schema.Types.ObjectId,
      ref: "Task",
      required: true,
      index: true,
    },
    dayNumber: {
      type: Number,
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    completed: {
      type: Boolean,
      default: false,
    },
    actualMinutesSpent: Number,
  },
  { timestamps: true }
);

// ‚úÖ ONLY THIS UNIQUE INDEX
ProgressSchema.index(
  { planId: 1, taskId: 1, dayNumber: 1 },
  { unique: true }
);

ProgressSchema.index({ planId: 1, dayNumber: 1 });

export default (mongoose.models.Progress as Model<IProgress>) ||
  mongoose.model<IProgress>("Progress", ProgressSchema);


  import mongoose, { Schema, Document, Model } from "mongoose";

export interface IPlan extends Document {
  userId: mongoose.Types.ObjectId;
  title: string;
  totalDays: number;
  startDate: Date;
  endDate: Date;
  dailyTimeLimitMinutes?: number;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}

const PlanSchema = new Schema<IPlan>(
  {
    userId: {
      type: Schema.Types.ObjectId,
      ref: "User",
      required: true,
      index: true,
    },
    title: { type: String, required: true, trim: true },

    totalDays: { type: Number, required: true },
    startDate: { type: Date, required: true },
    endDate: { type: Date, required: true },

    dailyTimeLimitMinutes: Number,

    isActive: { type: Boolean, default: true },
  },
  { timestamps: true }
);

PlanSchema.index({ userId: 1 });
PlanSchema.index({ startDate: 1 });
PlanSchema.index({ endDate: 1 });

export default (mongoose.models.Plan as Model<IPlan>) ||
  mongoose.model<IPlan>("Plan", PlanSchema);

// src/lib/date.ts

export function calculateActiveDay(
  startDate: Date,
  totalDays: number
) {
  const now = new Date();

  // Normalize both to local midnight
  const start = new Date(startDate);
  start.setHours(0, 0, 0, 0);

  const today = new Date(now);
  today.setHours(0, 0, 0, 0);

  const diffMs = today.getTime() - start.getTime();
  const diffDays = Math.floor(diffMs / 86400000);

  const activeDay = diffDays + 1;

  if (activeDay < 1) return 0;
  if (activeDay > totalDays) return totalDays + 1;

  return activeDay;
}



// src/controllers/task.controller.ts

import Task from "@/models/Task";
import Plan from "@/models/Plan";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

export async function createTask(req: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  const body = await req.json();
  const { planId, title, estimatedMinutes } = body;

  if (!planId || !title) {
    throw new Error("Missing required fields");
  }

  const plan = await Plan.findById(planId);
  if (!plan) throw new Error("Plan not found");

  if (plan.userId.toString() !== session.user.id) {
    throw new Error("Forbidden");
  }

  const task = await Task.create({
    planId,
    title,
    estimatedMinutes,
  });

  return task;
}

export async function getTasksByPlan(planId: string) {
  if (!planId) throw new Error("planId required");

  const tasks = await Task.find({ planId }).lean();
  return tasks;
}


// src/controllers/progress.controller.ts

import Progress from "@/models/Progress";
import Plan from "@/models/Plan";
import { calculateActiveDay } from "@/lib/date";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

export async function toggleProgress(req: Request) {
  const session = await getServerSession(authOptions);

  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  const body = await req.json();
  const { planId, taskId, dayNumber, completed } = body;

  if (!planId || !taskId || !dayNumber) {
    throw new Error("Invalid request data");
  }

  const plan = await Plan.findById(planId);

  if (!plan) {
    throw new Error("Plan not found");
  }

  if (plan.userId.toString() !== session.user.id) {
    throw new Error("Forbidden");
  }

  const activeDay = calculateActiveDay(
    plan.startDate,
    plan.totalDays
  );

  if (activeDay <= 0 || activeDay > plan.totalDays) {
    throw new Error("Plan not active");
  }

  if (dayNumber !== activeDay) {
    throw new Error("Day locked");
  }

  const progress = await Progress.findOneAndUpdate(
    {
      planId,
      taskId,
      dayNumber,
    },
    {
      $set: {
        completed: !!completed,
        date: new Date(),
      },
    },
    {
      upsert: true,
      new: true,
    }
  );

  return progress;
}

import Plan from "@/models/Plan";
import { calculateActiveDay } from "@/lib/date";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

export async function createPlan(req: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) throw new Error("Unauthorized");

  const body = await req.json();
  const { title, totalDays, startDate } = body;

  if (!title || !totalDays || totalDays < 1 || totalDays > 365) {
    throw new Error("Invalid input");
  }

  const start = new Date(startDate);
  const end = new Date(start);
  end.setDate(start.getDate() + totalDays - 1);

  const plan = await Plan.create({
    userId: session.user.id,
    title,
    totalDays,
    startDate: start,
    endDate: end,
  });

  return plan;
}

export async function getPlans(req: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) throw new Error("Unauthorized");

  const plans = await Plan.find({ userId: session.user.id }).lean();
  return plans;
}

// src/app/api/plan/[planId]/route.ts

import { NextResponse } from "next/server";
import { connectDB } from "@/config/db";
import Plan from "@/models/Plan";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

export async function GET(
  req: Request,
  context: { params: Promise<{ planId: string }> }
) {
  try {
    await connectDB();

    const session = await getServerSession(authOptions);
    if (!session?.user?.id)
      return NextResponse.json({ success: false, error: "Unauthorized" }, { status: 401 });

    const { planId } = await context.params;

    const plan = await Plan.findById(planId);
    if (!plan || plan.userId.toString() !== session.user.id)
      return NextResponse.json({ success: false, error: "Forbidden" }, { status: 403 });

    return NextResponse.json({ success: true, data: plan });
  } catch (error: any) {
    return NextResponse.json({ success: false, error: error.message }, { status: 400 });
  }
}

// src/app/api/plan/route.ts

import { NextResponse } from "next/server";
import { connectDB } from "@/config/db";
import Plan from "@/models/Plan";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

export async function GET() {
  try {
    await connectDB();

    const session = await getServerSession(authOptions);
    if (!session?.user?.id)
      return NextResponse.json({ success: false, error: "Unauthorized" }, { status: 401 });

    const plans = await Plan.find({ userId: session.user.id }).lean();

    return NextResponse.json({ success: true, data: plans });
  } catch (error: any) {
    return NextResponse.json({ success: false, error: error.message }, { status: 400 });
  }
}

export async function POST(req: Request) {
  try {
    await connectDB();

    const session = await getServerSession(authOptions);
    if (!session?.user?.id)
      return NextResponse.json({ success: false, error: "Unauthorized" }, { status: 401 });

    const body = await req.json();
    const { title, totalDays, startDate } = body;

    const start = new Date(startDate);
    const end = new Date(start);
    end.setDate(start.getDate() + totalDays - 1);

    const plan = await Plan.create({
      userId: session.user.id,
      title,
      totalDays,
      startDate: start,
      endDate: end,
    });

    return NextResponse.json({ success: true, data: plan }, { status: 201 });
  } catch (error: any) {
    return NextResponse.json({ success: false, error: error.message }, { status: 400 });
  }
}




import { NextResponse } from "next/server";
import { connectDB } from "@/config/db";
import Progress from "@/models/Progress";
import Plan from "@/models/Plan";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

export async function GET(
  req: Request,
  context: { params: Promise<{ planId: string }> }
) {
  try {
    await connectDB();

    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json(
        { success: false, error: "Unauthorized" },
        { status: 401 }
      );
    }

    const { planId } = await context.params;

    const [plan, progress] = await Promise.all([
      Plan.findById(planId).lean(),
      Progress.find({ planId }).lean(),
    ]);

    if (!plan || plan.userId.toString() !== session.user.id) {
      return NextResponse.json(
        { success: false, error: "Forbidden" },
        { status: 403 }
      );
    }

    return NextResponse.json({
      success: true,
      data: progress,
      meta: {
        totalDays: plan.totalDays,
        startDate: plan.startDate,
        endDate: plan.endDate,
        title: plan.title,
      },
    });
  } catch (error: any) {
    console.error("Progress GET error:", error);

    return NextResponse.json(
      { success: false, error: error.message },
      { status: 400 }
    );
  }
}

// src/app/api/progress/route.ts

import { NextResponse } from "next/server";
import { connectDB } from "@/config/db";
import { toggleProgress } from "@/controllers/progress.controller";

export async function POST(req: Request) {
  try {
    await connectDB();

    const result = await toggleProgress(req);

    return NextResponse.json({ success: true, data: result });
  } catch (error: any) {
    return NextResponse.json({ success: false, error: error.message }, { status: 400 });
  }
}

// src/app/api/task/route.ts

import { NextResponse } from "next/server";
import { connectDB } from "@/config/db";
import Task from "@/models/Task";
import Plan from "@/models/Plan";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";

export async function POST(req: Request) {
  try {
    await connectDB();

    const session = await getServerSession(authOptions);
    if (!session?.user?.id)
      return NextResponse.json({ success: false, error: "Unauthorized" }, { status: 401 });

    const { planId, title } = await req.json();

    const plan = await Plan.findById(planId);
    if (!plan || plan.userId.toString() !== session.user.id)
      return NextResponse.json({ success: false, error: "Forbidden" }, { status: 403 });

    const task = await Task.create({ planId, title });

    return NextResponse.json({ success: true, data: task }, { status: 201 });
  } catch (error: any) {
    return NextResponse.json({ success: false, error: error.message }, { status: 400 });
  }
}





// "use client";

// import { useEffect, useState } from "react";
// import { useParams, useRouter } from "next/navigation";

// export default function PlanDashboard() {
//   const { planId } = useParams();
//   const router = useRouter();
//   const [plan, setPlan] = useState<any>(null);

//   async function loadPlan() {
//     const res = await fetch(`/api/plan/${planId}`, {
//       credentials: "include",
//     });
//     const data = await res.json();

//     if (res.ok && data.success) {
//       setPlan(data.data);
//     }
//   }

//   useEffect(() => {
//     if (planId) loadPlan();
//   }, [planId]);

//   if (!plan) return <div className="p-6">Loading...</div>;

//   return (
//     <div className="min-h-screen bg-zinc-100 p-6">
//       <h1 className="text-2xl font-bold mb-4">{plan.title}</h1>

//       <div className="flex gap-4">
//         <button
//           onClick={() => router.push(`/plan/${planId}/tasks`)}
//           className="bg-black text-white px-4 py-2 rounded"
//         >
//           Manage Tasks
//         </button>

//         <button
//           onClick={() => router.push(`/plan/${planId}/progress`)}
//           className="bg-green-600 text-white px-4 py-2 rounded"
//         >
//           View Progress
//         </button>
//       </div>
//     </div>
//   );
// }




"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams } from "next/navigation";
import { 
  LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
  Area, AreaChart, ComposedChart
} from 'recharts';

export default function PlanWorkspace() {
  const { planId } = useParams();

  const [plan, setPlan] = useState<any>(null);
  const [tasks, setTasks] = useState<any[]>([]);
  const [progressMap, setProgressMap] = useState<Record<string, boolean>>({});
  const [taskTitle, setTaskTitle] = useState("");
  const [loading, setLoading] = useState(true);
  const [activeChart, setActiveChart] = useState('line');

  /* ================= SAFE JSON ================= */

  async function safeJson(res: Response) {
    const text = await res.text();
    try {
      return text ? JSON.parse(text) : {};
    } catch {
      console.error("Invalid JSON:", text);
      return {};
    }
  }

  /* ================= LOADERS ================= */

  async function loadPlan() {
    try {
      const res = await fetch(`/api/plan/${planId}`, {
        credentials: "include",
      });
      const data = await safeJson(res);
      if (res.ok && data.success) setPlan(data.data);
    } catch (err) {
      console.error("Plan load failed:", err);
    }
  }

  async function loadTasks() {
    try {
      const res = await fetch(`/api/task/${planId}`, {
        credentials: "include",
      });
      const data = await safeJson(res);
      setTasks(res.ok && data.success ? data.data || [] : []);
    } catch (err) {
      console.error("Task load failed:", err);
      setTasks([]);
    }
  }

  async function loadProgress() {
    try {
      const res = await fetch(`/api/progress/${planId}`, {
        credentials: "include",
      });
      const data = await safeJson(res);

      if (!res.ok || !data.success) {
        setProgressMap({});
        return;
      }

      const map: Record<string, boolean> = {};
      data.data.forEach((p: any) => {
        map[`${p.taskId}-${p.dayNumber}`] = p.completed;
      });

      setProgressMap(map);
    } catch (err) {
      console.error("Progress load failed:", err);
      setProgressMap({});
    }
  }

  /* ================= ADD TASK ================= */

  async function addTask() {
    if (!taskTitle.trim()) return;

    try {
      await fetch("/api/task", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ planId, title: taskTitle }),
      });

      setTaskTitle("");
      loadTasks();
    } catch (err) {
      console.error("Add task failed:", err);
    }
  }

  /* ================= OPTIMISTIC TOGGLE ================= */

  async function toggle(taskId: string, day: number) {
    const key = `${taskId}-${day}`;
    const newValue = !progressMap[key];

    setProgressMap((prev) => ({ ...prev, [key]: newValue }));

    try {
      const res = await fetch("/api/progress", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          planId,
          taskId,
          dayNumber: day,
          completed: newValue,
        }),
      });

      const data = await safeJson(res);

      if (!res.ok || !data.success) {
        setProgressMap((prev) => ({ ...prev, [key]: !newValue }));
      }
    } catch {
      setProgressMap((prev) => ({ ...prev, [key]: !newValue }));
    }
  }

  /* ================= EFFECT ================= */

  useEffect(() => {
    if (!planId) return;
    Promise.all([loadPlan(), loadTasks(), loadProgress()]).finally(() =>
      setLoading(false)
    );
  }, [planId]);

  /* =======================================================
     ‚úÖ EVERYTHING BELOW IS SAFE (no early returns above)
  ======================================================== */

  /* ================= ACTIVE DAY ================= */

  let activeDay = 0;

  if (plan?.startDate) {
    const today = new Date();
    const start = new Date(plan.startDate);

    start.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);

    activeDay =
      Math.floor((today.getTime() - start.getTime()) / 86400000) + 1;
  }

  /* ================= METRICS ================= */

  const totalCells = (plan?.totalDays || 0) * tasks.length;
  const completedCount = Object.values(progressMap).filter(Boolean).length;
  const completionPercent =
    totalCells === 0
      ? 0
      : Math.round((completedCount / totalCells) * 100);

  /* ================= STREAK ================= */

  const streak = useMemo(() => {
    if (!activeDay || !plan) return 0;

    let currentStreak = 0;

    for (let d = activeDay; d >= 1; d--) {
      let allDone = true;

      for (const t of tasks) {
        if (!progressMap[`${t._id}-${d}`]) {
          allDone = false;
          break;
        }
      }

      if (allDone) currentStreak++;
      else break;
    }

    return currentStreak;
  }, [progressMap, tasks, activeDay, plan]);

  /* ================= TASK PROGRESS ================= */
/* ================= TASK PROGRESS ================= */

const taskProgress = useMemo(() => {
  if (!plan) return [];

  return tasks.map((t) => {
    let done = 0;

    for (let d = 1; d <= plan.totalDays; d++) {
      if (progressMap[`${t._id}-${d}`]) done++;
    }

    const percent =
      plan.totalDays === 0
        ? 0
        : Math.round((done / plan.totalDays) * 100);

    return {
      _id: t._id,            // ‚úÖ ADD THIS (critical)
      name: t.title,
      value: percent,
      completed: done,
      total: plan.totalDays,
    };
  });
}, [tasks, progressMap, plan]);

  /* ================= DAILY PROGRESS DATA ================= */

  const dailyProgressData = useMemo(() => {
    if (!plan) return [];

    const data = [];
    for (let d = 1; d <= (activeDay || plan.totalDays); d++) {
      let completedToday = 0;
      for (const t of tasks) {
        if (progressMap[`${t._id}-${d}`]) completedToday++;
      }
      const percent = tasks.length > 0 ? Math.round((completedToday / tasks.length) * 100) : 0;
      
      data.push({
        day: d,
        completed: completedToday,
        total: tasks.length,
        percent,
        isActive: d === activeDay,
        isFuture: d > (activeDay || 0)
      });
    }
    return data;
  }, [progressMap, tasks, activeDay, plan]);

  /* ================= HEAT COLOR ================= */

  function getHeatColor(checked: boolean, locked: boolean) {
    if (locked) return "bg-gray-700";
    if (!checked) return "bg-gray-800 hover:bg-gray-700";
    return "bg-emerald-600 hover:bg-emerald-500";
  }

  /* ================= CHART COLORS ================= */

  const CHART_COLORS = {
    primary: '#10b981',
    secondary: '#3b82f6',
    accent: '#8b5cf6',
    warning: '#f59e0b',
    danger: '#ef4444',
    background: '#1f2937',
    grid: '#374151',
    text: '#9ca3af'
  };

  const PIE_COLORS = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899'];

  /* ================= EARLY RETURNS (NOW SAFE) ================= */

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center text-gray-300">
        Loading...
      </div>
    );
  }

  if (!plan) {
    return <div className="min-h-screen bg-gray-900 p-6 text-gray-300">Plan not found</div>;
  }

  /* ================= UI ================= */

  return (
    <div className="min-h-screen bg-gray-900 p-6 text-gray-300">
      <div className="bg-gray-800 p-6 rounded-xl shadow-xl border border-gray-700 space-y-6">
        {/* HEADER */}
        <div className="flex justify-between items-center">
          <h1 className="text-2xl font-bold text-white">{plan.title}</h1>
          <div className="flex gap-3">
            <div className="text-sm bg-gray-700 text-emerald-400 px-3 py-1 rounded-full border border-gray-600">
              Overall: {completionPercent}%
            </div>
            <div className="text-sm bg-gray-700 text-amber-400 px-3 py-1 rounded-full border border-gray-600">
              Streak: {streak} üî•
            </div>
          </div>
        </div>

        {/* ADD TASK */}
        <div className="flex gap-2">
          <input
            value={taskTitle}
            onChange={(e) => setTaskTitle(e.target.value)}
            className="bg-gray-700 border-gray-600 text-white p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="New Task"
          />
          <button
            onClick={addTask}
            className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 rounded transition-colors"
          >
            Add
          </button>
        </div>

        {/* DAILY MATRIX */}
        <div className="overflow-x-auto rounded-lg border border-gray-700">
          <table className="min-w-max border-collapse w-full text-sm">
            <thead>
              <tr className="bg-gray-700">
                <th className="sticky left-0 bg-gray-700 border-gray-600 p-3 z-10 text-left text-gray-300 font-semibold">
                  Day
                </th>
                {tasks.map((t) => (
                  <th key={t._id} className="border-gray-600 p-3 text-gray-300 font-semibold">
                    {t.title}
                  </th>
                ))}
              </tr>
            </thead>

            <tbody>
              {Array.from({ length: plan.totalDays }).map((_, i) => {
                const day = i + 1;
                const isActive = day === activeDay;
                const locked = day !== activeDay;

                return (
                  <tr 
                    key={day} 
                    className={`${isActive ? 'bg-gray-700/50' : ''} hover:bg-gray-700/30 transition-colors`}
                  >
                    <td className="sticky left-0 bg-gray-800 border-gray-700 p-3 font-medium text-gray-400">
                      Day {day}
                      {isActive && <span className="ml-2 text-emerald-400">‚óè</span>}
                    </td>

                    {tasks.map((t) => {
                      const key = `${t._id}-${day}`;
                      const checked = progressMap[key] || false;

                      return (
                        <td key={t._id} className="border-gray-700 text-center p-3">
                          <input
                            type="checkbox"
                            checked={checked}
                            disabled={locked}
                            onChange={() => toggle(t._id, day)}
                            className={`w-4 h-4 rounded ${
                              locked
                                ? "opacity-40 cursor-not-allowed"
                                : "cursor-pointer accent-emerald-500"
                            }`}
                          />
                        </td>
                      );
                    })}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>

        {/* ================= PREMIUM ANALYTICS ================= */}

        <div className="mt-10 space-y-8">
          <div className="flex flex-wrap justify-between items-center gap-4">
            <h2 className="text-xl font-bold text-white">Progress Analytics</h2>
            
            {/* Chart Type Selector */}
            <div className="flex gap-2 bg-gray-700 p-1 rounded-lg">
              {['line', 'bar', 'area', 'composed'].map((type) => (
                <button
                  key={type}
                  onClick={() => setActiveChart(type)}
                  className={`px-3 py-1 rounded-md text-sm capitalize transition-colors ${
                    activeChart === type 
                      ? 'bg-emerald-600 text-white' 
                      : 'text-gray-400 hover:text-white'
                  }`}
                >
                  {type}
                </button>
              ))}
            </div>
          </div>

          {/* Main Chart */}
          <div className="bg-gray-700/30 p-6 rounded-xl border border-gray-700">
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                {activeChart === 'line' ? (
                  <LineChart data={dailyProgressData}>
                    <CartesianGrid strokeDasharray="3 3" stroke={CHART_COLORS.grid} />
                    <XAxis dataKey="day" stroke={CHART_COLORS.text} />
                    <YAxis stroke={CHART_COLORS.text} />
                    <Tooltip 
                      contentStyle={{ 
                        backgroundColor: '#1f2937', 
                        border: '1px solid #374151',
                        borderRadius: '0.5rem',
                        color: '#fff'
                      }}
                    />
                    <Legend />
                    <Line 
                      type="monotone" 
                      dataKey="percent" 
                      name="Completion %" 
                      stroke={CHART_COLORS.primary} 
                      strokeWidth={2}
                      dot={{ fill: CHART_COLORS.primary }}
                    />
                  </LineChart>
                ) : activeChart === 'bar' ? (
                  <BarChart data={dailyProgressData}>
                    <CartesianGrid strokeDasharray="3 3" stroke={CHART_COLORS.grid} />
                    <XAxis dataKey="day" stroke={CHART_COLORS.text} />
                    <YAxis stroke={CHART_COLORS.text} />
                    <Tooltip 
                      contentStyle={{ 
                        backgroundColor: '#1f2937', 
                        border: '1px solid #374151',
                        borderRadius: '0.5rem',
                        color: '#fff'
                      }}
                    />
                    <Legend />
                    <Bar dataKey="completed" name="Completed Tasks" fill={CHART_COLORS.primary} />
                    <Bar dataKey="total" name="Total Tasks" fill={CHART_COLORS.secondary} />
                  </BarChart>
                ) : activeChart === 'area' ? (
                  <AreaChart data={dailyProgressData}>
                    <CartesianGrid strokeDasharray="3 3" stroke={CHART_COLORS.grid} />
                    <XAxis dataKey="day" stroke={CHART_COLORS.text} />
                    <YAxis stroke={CHART_COLORS.text} />
                    <Tooltip 
                      contentStyle={{ 
                        backgroundColor: '#1f2937', 
                        border: '1px solid #374151',
                        borderRadius: '0.5rem',
                        color: '#fff'
                      }}
                    />
                    <Legend />
                    <Area 
                      type="monotone" 
                      dataKey="percent" 
                      name="Completion %" 
                      stroke={CHART_COLORS.primary}
                      fill={CHART_COLORS.primary}
                      fillOpacity={0.3}
                    />
                  </AreaChart>
                ) : (
                  <ComposedChart data={dailyProgressData}>
                    <CartesianGrid strokeDasharray="3 3" stroke={CHART_COLORS.grid} />
                    <XAxis dataKey="day" stroke={CHART_COLORS.text} />
                    <YAxis stroke={CHART_COLORS.text} />
                    <Tooltip 
                      contentStyle={{ 
                        backgroundColor: '#1f2937', 
                        border: '1px solid #374151',
                        borderRadius: '0.5rem',
                        color: '#fff'
                      }}
                    />
                    <Legend />
                    <Bar dataKey="completed" name="Completed" fill={CHART_COLORS.secondary} />
                    <Line type="monotone" dataKey="percent" name="%" stroke={CHART_COLORS.primary} strokeWidth={2} />
                  </ComposedChart>
                )}
              </ResponsiveContainer>
            </div>
          </div>

          {/* Stats Grid */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {/* Completion Rate Card */}
            <div className="bg-gray-700/30 p-4 rounded-xl border border-gray-700">
              <h3 className="text-sm text-gray-400 mb-2">Completion Rate</h3>
              <div className="text-2xl font-bold text-white">{completionPercent}%</div>
              <div className="mt-2 h-2 bg-gray-700 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-emerald-500 rounded-full transition-all"
                  style={{ width: `${completionPercent}%` }}
                />
              </div>
              <div className="mt-2 text-xs text-gray-400">
                {completedCount} / {totalCells} tasks
              </div>
            </div>

            {/* Streak Card */}
            <div className="bg-gray-700/30 p-4 rounded-xl border border-gray-700">
              <h3 className="text-sm text-gray-400 mb-2">Current Streak</h3>
              <div className="text-2xl font-bold text-amber-400">{streak} days üî•</div>
              <div className="mt-2 text-xs text-gray-400">
                {streak > 0 ? 'Keep it up!' : 'Start your streak today!'}
              </div>
            </div>

            {/* Progress Card */}
            <div className="bg-gray-700/30 p-4 rounded-xl border border-gray-700">
              <h3 className="text-sm text-gray-400 mb-2">Today's Progress</h3>
              {activeDay > 0 && activeDay <= plan.totalDays ? (
                <>
                  <div className="text-2xl font-bold text-white">
                    {dailyProgressData[activeDay - 1]?.completed || 0} / {tasks.length}
                  </div>
                  <div className="mt-2 text-xs text-gray-400">
                    {tasks.length - (dailyProgressData[activeDay - 1]?.completed || 0)} tasks remaining
                  </div>
                </>
              ) : (
                <div className="text-gray-400">No active day</div>
              )}
            </div>
          </div>

          {/* Task Progress Bars */}
          <div className="bg-gray-700/30 p-6 rounded-xl border border-gray-700">
            <h3 className="text-lg font-semibold text-white mb-4">Task Breakdown</h3>
            <div className="space-y-4">
              {taskProgress.map((t) => (
<div key={t._id}>
                  <div className="flex justify-between text-sm mb-1">
                    <span className="text-gray-300">{t.name}</span>
                    <span className="text-emerald-400 font-medium">{t.value}%</span>
                  </div>
                  <div className="w-full bg-gray-700 rounded-full h-2.5 overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all rounded-full"
                      style={{ width: `${t.value}%` }}
                    />
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {t.completed} / {t.total} days completed
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Mini Calendar View */}
          <div className="bg-gray-700/30 p-6 rounded-xl border border-gray-700">
            <h3 className="text-lg font-semibold text-white mb-4">Weekly Overview</h3>
            <div className="grid grid-cols-7 gap-2">
              {dailyProgressData.slice(-7).map((day) => (
                <div key={day.day} className="text-center">
                  <div className="text-xs text-gray-400 mb-1">D{day.day}</div>
                  <div 
                    className={`h-12 rounded-lg flex items-center justify-center text-xs font-medium
                      ${day.isFuture ? 'bg-gray-700 text-gray-500' :
                        day.percent === 100 ? 'bg-emerald-600 text-white' :
                        day.percent > 66 ? 'bg-emerald-600/70 text-white' :
                        day.percent > 33 ? 'bg-emerald-600/40 text-white' :
                        day.percent > 0 ? 'bg-emerald-600/20 text-gray-300' :
                        'bg-gray-700 text-gray-500'
                      }`}
                  >
                    {day.percent}%
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}


"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";

export default function MyPlansPage() {
  const [plans, setPlans] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const router = useRouter();


  async function safeJson(res: Response) {
    const text = await res.text();
    try {
      return text ? JSON.parse(text) : {};
    } catch {
      console.error("Invalid JSON:", text);
      return {};
    }
  }


  async function loadPlans() {
    try {
      const res = await fetch("/api/plan", {
        credentials: "include",
      });

      const data = await safeJson(res);

      if (res.ok && data.success) {
        setPlans(data.data || []);
      } else {
        setPlans([]);
      }
    } catch (err) {
      console.error("Failed to load plans:", err);
      setPlans([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    loadPlans();
  }, []);


  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-zinc-900 to-black">
        <div className="animate-pulse text-white/70 text-lg">
          Loading your plans...
        </div>
      </div>
    );
  }


  return (
    <div className="min-h-screen bg-gradient-to-br from-zinc-900 via-black to-zinc-900 p-6 text-white">
      <div className="max-w-6xl mx-auto space-y-8">

        <div className="flex flex-wrap justify-between items-center gap-4">
          <h1 className="text-3xl font-bold tracking-tight">
          My Study Plans
          </h1>

          <div className="text-sm text-white/60">
            {plans.length} plan{plans.length !== 1 ? "s" : ""}
          </div>
        </div>

        {plans.length === 0 && (
          <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-12 text-center">
            <div className="text-4xl mb-3">üöÄ</div>
            <p className="text-white/70 mb-2 font-medium">
              No study plans yet
            </p>
            <p className="text-white/40 text-sm">
              Create your first plan to start tracking progress.
            </p>
          </div>
        )}

        <div className="grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
          {plans.map((plan) => {
            const startDate = new Date(plan.startDate);

            let previewPercent = 0;
            if (plan.startDate) {
              const today = new Date();
              const diff =
                Math.floor(
                  (today.getTime() - startDate.getTime()) / 86400000
                ) + 1;

              previewPercent = Math.min(
                100,
                Math.round((diff / plan.totalDays) * 100)
              );
            }

            return (
             <div
  key={plan._id}
onClick={() => router.push(`/plan/${plan._id}`)}
  className="
    group cursor-pointer
    backdrop-blur-xl bg-white/5
    border border-white/10
    rounded-2xl p-5
    hover:bg-white/10
    hover:scale-[1.02]
    transition-all duration-300
    shadow-lg hover:shadow-2xl
  "
>

                <div className="flex justify-between items-start mb-4">
                  <h2 className="text-lg font-semibold leading-tight">
                    {plan.title}
                  </h2>

                  <div className="relative w-10 h-10">
                    <svg viewBox="0 0 36 36" className="w-10 h-10">
                      <path
                        d="M18 2a16 16 0 1 1 0 32a16 16 0 1 1 0-32"
                        fill="none"
                        stroke="rgba(255,255,255,0.15)"
                        strokeWidth="3"
                      />
                      <path
                        d="M18 2a16 16 0 1 1 0 32a16 16 0 1 1 0-32"
                        fill="none"
                        stroke="rgb(16 185 129)"
                        strokeWidth="3"
                        strokeDasharray={`${previewPercent}, 100`}
                        strokeLinecap="round"
                      />
                    </svg>
                  </div>
                </div>

                <div className="space-y-1 text-sm">
                  <p className="text-white/70">
                    ‚è≥ {plan.totalDays} days
                  </p>
                  <p className="text-white/40 text-xs">
                    üìÖ {startDate.toDateString()}
                  </p>
                </div>

                <div className="mt-4 opacity-0 group-hover:opacity-100 transition text-xs text-emerald-400">
                  Open dashboard ‚Üí
                </div>
              </div>
            );
          })}
        </div>

      </div>
    </div>
  );
}


check all files work well but if anything is unsuse or multuple time use or its is safe production grade check also ensure only user can manage their plans 